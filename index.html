<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f0f0f">
  <title>LinkShare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: { main: '#0f0f0f', side: '#1a1a1a', card: '#222222', hover: '#2a2a2a' },
            border: '#333333',
            txt: { primary: '#e5e5e5', secondary: '#888888', disabled: '#555555' },
            accent: { blue: '#3b82f6', green: '#22c55e', red: '#ef4444' }
          }
        }
      }
    }
  </script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDQZ7hYU-QGCDp84ZbL402GGiCuLKHMRyQ",
      authDomain: "linkshare-1b9c5.firebaseapp.com",
      projectId: "linkshare-1b9c5",
      storageBucket: "linkshare-1b9c5.firebasestorage.app",
      messagingSenderId: "456458857608",
      appId: "1:456458857608:web:286c980d09c70e7b26833d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Expose to global scope for inline handlers
    window.fbAuth = auth;
    window.fbDb = db;
    window.fbSignInWithPopup = signInWithPopup;
    window.fbGoogleProvider = new GoogleAuthProvider();
    window.fbSignOut = signOut;
    window.fbOnAuthStateChanged = onAuthStateChanged;
    window.fbCollection = collection;
    window.fbDoc = doc;
    window.fbAddDoc = addDoc;
    window.fbUpdateDoc = updateDoc;
    window.fbDeleteDoc = deleteDoc;
    window.fbOnSnapshot = onSnapshot;
    window.fbQuery = query;
    window.fbOrderBy = orderBy;
    window.fbWhere = where;
    window.fbGetDocs = getDocs;
    window.fbArrayUnion = arrayUnion;
    window.fbArrayRemove = arrayRemove;

    // Signal that Firebase is ready
    window.firebaseReady = true;
    if (window.onFirebaseReady) window.onFirebaseReady();
  </script>
  <script>
    const isElectron = !!window.electronAPI;
    if (!isElectron && 'serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow: hidden; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    .tree-item { cursor: pointer; transition: all 0.15s; }
    .tree-item:hover { background: rgba(255,255,255,0.05); }
    .tree-item.selected { background: rgba(59,130,246,0.15); color: #3b82f6; }
    .link-card { cursor: pointer; transition: all 0.2s; }
    .link-card:hover { background: #2a2a2a; border-color: #444; }
    .link-card.selected { border-color: #3b82f6; background: rgba(59,130,246,0.08); }
    .action-btn { transition: all 0.2s; }
    .action-btn:hover:not(:disabled) { transform: translateY(-1px); }
    .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .drag-region { -webkit-app-region: drag; }
    .no-drag { -webkit-app-region: no-drag; }
    .modal-overlay { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    .pull-indicator { position: fixed; top: 0; left: 50%; transform: translateX(-50%) translateY(-50px); z-index: 100; background: #222; border: 1px solid #444; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s, opacity 0.2s; opacity: 0; pointer-events: none; }
    .pull-indicator.visible { opacity: 1; }
    .pull-indicator.refreshing { animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: translateX(-50%) rotate(360deg); } }
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 30; }
    .sidebar-overlay.active { display: block; }
    .hamburger-btn { display: none; }
    @media (max-width: 767px) {
      .hamburger-btn { display: flex; }
      .sidebar { position: fixed; left: -100%; top: 0; bottom: 0; width: 280px; z-index: 40; transition: left 0.25s ease; }
      .sidebar.open { left: 0; }
      .sidebar-overlay.active { display: block; }
      .modal-inner { width: 100% !important; margin: 0 16px; }
      .logs-inner { width: 100% !important; margin: 0 16px; }
      .action-bar-buttons { flex-wrap: wrap; }
    }
  </style>
</head>
<body class="bg-bg-main text-txt-primary w-screen h-screen flex flex-col">
  <div id="pullIndicator" class="pull-indicator"><span style="font-size:16px">â†»</span></div>

  <!-- Login Screen -->
  <div id="loginScreen" class="flex-1 flex flex-col items-center justify-center gap-6">
    <div class="text-3xl font-bold tracking-wide">LinkShare</div>
    <div class="text-sm text-txt-secondary">ë§í¬ë¥¼ í´ë”ë¡œ ì •ë¦¬í•˜ê³  ê³µìœ í•˜ì„¸ìš”</div>
    <button id="loginBtn" onclick="doLogin()" class="mt-4 px-6 py-3 bg-white text-black text-sm font-medium rounded-xl hover:bg-gray-200 transition flex items-center gap-3">
      <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
      Googleë¡œ ë¡œê·¸ì¸
    </button>
    <div id="loginError" class="text-xs text-accent-red hidden"></div>
  </div>

  <!-- Main App (hidden until login) -->
  <div id="mainApp" class="flex-1 flex flex-col hidden">

    <!-- Title Bar -->
    <div id="titleBar" class="flex items-center justify-between px-4 h-10 bg-bg-main border-b border-border shrink-0">
      <div class="flex items-center gap-2">
        <button onclick="toggleSidebar()" class="hamburger-btn items-center justify-center w-8 h-8 rounded-lg hover:bg-bg-hover transition text-txt-secondary">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
        </button>
        <span class="text-sm font-semibold tracking-wide">LinkShare</span>
      </div>
      <div class="no-drag flex items-center gap-3 text-xs text-txt-secondary">
        <span id="userName" class="text-txt-primary"></span>
        <button onclick="showLogs()" class="hover:text-txt-primary transition">ê¸°ë¡</button>
        <button onclick="doLogout()" class="hover:text-accent-red transition">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <!-- Content Area -->
    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar Overlay (mobile) -->
      <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>
      <!-- Left: Directory Tree -->
      <div id="sidebar" class="sidebar w-64 shrink-0 bg-bg-side border-r border-border flex flex-col overflow-hidden">
        <div class="p-2 flex gap-1">
          <button onclick="showCreateGroupModal()" class="flex-1 px-2 py-1.5 bg-accent-blue/15 text-accent-blue text-[11px] rounded-lg border border-accent-blue/20 hover:bg-accent-blue/25 transition">+ ê·¸ë£¹</button>
          <button onclick="showJoinGroupModal()" class="flex-1 px-2 py-1.5 bg-accent-green/15 text-accent-green text-[11px] rounded-lg border border-accent-green/20 hover:bg-accent-green/25 transition">ì°¸ì—¬</button>
        </div>
        <div id="tree" class="flex-1 overflow-y-auto px-2 pb-4" onclick="if(event.target===this||event.target.id==='tree'){selectedFolderId=null;selectedLinkId=null;updateUI();}"></div>
      </div>

      <!-- Right: Link Cards -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <div class="p-4 border-b border-border flex items-center gap-2">
          <span id="currentPath" class="text-sm text-txt-secondary">í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
        </div>
        <div id="links" class="flex-1 overflow-y-auto p-4 grid grid-cols-1 gap-3 content-start"></div>
        <div id="emptyLinks" class="flex-1 items-center justify-center text-txt-disabled text-sm hidden">
          <span>ì´ í´ë”ì— ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤</span>
        </div>
      </div>
    </div>

    <!-- Action Bar -->
    <div class="shrink-0 border-t border-border bg-bg-side px-5 py-3">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <span id="selectionInfo" class="text-xs text-txt-secondary">í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”</span>
        <div class="flex flex-wrap gap-2">
          <button id="btnAddFolder" onclick="showAddFolderModal()" disabled
            class="action-btn px-3 py-1.5 bg-accent-blue/20 text-accent-blue text-xs rounded-lg border border-accent-blue/30 hover:bg-accent-blue/30">
            + í´ë” ì¶”ê°€
          </button>
          <button id="btnAddLink" onclick="showAddLinkModal()" disabled
            class="action-btn px-3 py-1.5 bg-accent-green/20 text-accent-green text-xs rounded-lg border border-accent-green/30 hover:bg-accent-green/30">
            + ë§í¬ ì¶”ê°€
          </button>
          <button id="btnRename" onclick="showRenameModal()" disabled
            class="action-btn px-3 py-1.5 bg-bg-card text-txt-secondary text-xs rounded-lg border border-border hover:text-txt-primary">
            âœï¸ ì´ë¦„ ë³€ê²½
          </button>
          <button id="btnDelete" onclick="deleteSelected()" disabled
            class="action-btn px-3 py-1.5 bg-accent-red/20 text-accent-red text-xs rounded-lg border border-accent-red/30 hover:bg-accent-red/30">
            ğŸ—‘ ì‚­ì œ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 modal-overlay z-[60] hidden items-center justify-center">
    <div class="modal-inner bg-bg-card rounded-xl border border-border shadow-2xl w-96 p-6">
      <h3 id="modalTitle" class="text-base font-semibold mb-4"></h3>
      <div id="modalBody"></div>
      <div class="flex justify-end gap-2 mt-5">
        <button onclick="closeModal()" class="px-4 py-2 text-xs text-txt-secondary rounded-lg border border-border hover:bg-bg-hover transition">ì·¨ì†Œ</button>
        <button id="modalConfirm" class="px-4 py-2 text-xs text-white bg-accent-blue rounded-lg hover:bg-blue-600 transition">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- Logs Modal -->
  <div id="logsModal" class="fixed inset-0 modal-overlay z-50 hidden items-center justify-center">
    <div class="logs-inner bg-bg-card rounded-xl border border-border shadow-2xl w-[500px] max-h-[70vh] flex flex-col p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-base font-semibold">ìˆ˜ì • ê¸°ë¡</h3>
        <button onclick="closeLogsModal()" class="text-txt-secondary hover:text-txt-primary transition text-lg">âœ•</button>
      </div>
      <div id="logsList" class="flex-1 overflow-y-auto space-y-2"></div>
    </div>
  </div>

  <!-- Group Settings Modal -->
  <div id="groupModal" class="fixed inset-0 modal-overlay z-50 hidden items-center justify-center">
    <div class="modal-inner bg-bg-card rounded-xl border border-border shadow-2xl w-96 max-h-[80vh] flex flex-col p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 id="groupModalTitle" class="text-base font-semibold">ê·¸ë£¹ ì„¤ì •</h3>
        <button onclick="closeGroupModal()" class="text-txt-secondary hover:text-txt-primary transition text-lg">âœ•</button>
      </div>
      <div id="groupModalBody" class="flex-1 overflow-y-auto"></div>
    </div>
  </div>

<script>
// â”€â”€ State â”€â”€
let folders = [];
let linksData = [];
let logs = [];
let groups = [];
let currentUser = null;
let selectedFolderId = null;
let selectedLinkId = null;
let unsubFolders = null;
let unsubLinks = null;
let unsubLogs = null;
let unsubGroups = null;

// â”€â”€ Auth â”€â”€
async function doLogin() {
  try {
    await window.fbSignInWithPopup(window.fbAuth, window.fbGoogleProvider);
  } catch(e) {
    const errEl = document.getElementById('loginError');
    errEl.textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message;
    errEl.classList.remove('hidden');
  }
}

async function doLogout() {
  await window.fbSignOut(window.fbAuth);
}

function onAuthChanged(user) {
  currentUser = user;
  if (user) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('flex');
    document.getElementById('userName').textContent = user.displayName || user.email;
    startListening();
  } else {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('flex');
    stopListening();
    folders = [];
    linksData = [];
    logs = [];
    groups = [];
    updateUI();
  }
}

// â”€â”€ Firestore Listeners â”€â”€
function startListening() {
  const db = window.fbDb;

  // Listen to groups (user is member of)
  const groupsRef = window.fbCollection(db, 'groups');
  const groupsQuery = window.fbQuery(groupsRef, window.fbWhere('members', 'array-contains', currentUser.uid));
  unsubGroups = window.fbOnSnapshot(groupsQuery, (snapshot) => {
    groups = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    updateUI();
  });

  // Listen to folders
  const foldersRef = window.fbCollection(db, 'folders');
  const foldersQuery = window.fbQuery(foldersRef, window.fbOrderBy('order'));
  unsubFolders = window.fbOnSnapshot(foldersQuery, (snapshot) => {
    folders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    // Filter: show group folders user belongs to + own private
    const myGroupIds = groups.map(g => g.id);
    folders = folders.filter(f =>
      (f.type === 'shared' && f.groupId && myGroupIds.includes(f.groupId)) ||
      (f.type === 'shared' && !f.groupId) ||
      (f.type === 'private' && f.ownerId === currentUser.uid)
    );
    // ê¸°ì¡´ ê³µìœ í´ë” ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜
    migrateLegacyFolders();
    updateUI();
  });

  // Listen to links
  const linksRef = window.fbCollection(db, 'links');
  const linksQuery = window.fbQuery(linksRef, window.fbOrderBy('order'));
  unsubLinks = window.fbOnSnapshot(linksQuery, (snapshot) => {
    linksData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    updateUI();
  });

  // Listen to logs
  const logsRef = window.fbCollection(db, 'logs');
  const logsQuery = window.fbQuery(logsRef, window.fbOrderBy('timestamp', 'desc'));
  unsubLogs = window.fbOnSnapshot(logsQuery, (snapshot) => {
    logs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    // Filter: show shared logs + own private logs
    logs = logs.filter(l =>
      l.folderType === 'shared' || !l.folderType || (l.folderType === 'private' && l.userId === currentUser.uid)
    );
  });
}

function stopListening() {
  if (unsubGroups) unsubGroups();
  if (unsubFolders) unsubFolders();
  if (unsubLinks) unsubLinks();
  if (unsubLogs) unsubLogs();
}

// â”€â”€ Firestore Write Operations â”€â”€
async function addFolder(data) {
  await window.fbAddDoc(window.fbCollection(window.fbDb, 'folders'), data);
}

async function addLink(data) {
  return await window.fbAddDoc(window.fbCollection(window.fbDb, 'links'), data);
}

async function updateLink(id, data) {
  await window.fbUpdateDoc(window.fbDoc(window.fbDb, 'links', id), data);
}

async function updateFolder(id, data) {
  await window.fbUpdateDoc(window.fbDoc(window.fbDb, 'folders', id), data);
}

async function removeFolder(id) {
  await window.fbDeleteDoc(window.fbDoc(window.fbDb, 'folders', id));
}

async function removeLink(id) {
  await window.fbDeleteDoc(window.fbDoc(window.fbDb, 'links', id));
}

async function addLogEntry(action, target, targetId, targetName, detail, folderType) {
  await window.fbAddDoc(window.fbCollection(window.fbDb, 'logs'), {
    action, target, targetId, targetName, detail,
    folderType: folderType || 'shared',
    userId: currentUser.uid,
    user: currentUser.email,
    userName: currentUser.displayName || currentUser.email,
    timestamp: Date.now()
  });
}

// â”€â”€ Tree Rendering â”€â”€
function renderTree() {
  const tree = document.getElementById('tree');
  tree.innerHTML = '';

  // Render each group
  groups.forEach(group => {
    const groupRoots = folders.filter(f => !f.parentId && f.type === 'shared' && f.groupId === group.id);
    const isOwner = group.ownerId === currentUser.uid;

    const groupHeader = document.createElement('div');
    groupHeader.className = 'flex items-center justify-between px-2 py-1.5 mt-1';
    groupHeader.innerHTML = `
      <span class="text-[10px] text-txt-disabled font-bold uppercase tracking-widest truncate">â”€â”€ ${esc(group.name)} â”€â”€</span>
      <button onclick="showGroupSettings('${group.id}')" class="text-txt-disabled hover:text-txt-secondary text-xs transition shrink-0 ml-1">âš™</button>
    `;
    tree.appendChild(groupHeader);
    groupRoots.forEach(f => tree.appendChild(renderTreeItem(f, 0)));
  });

  // Legacy shared folders (no groupId) - shown if any exist
  const legacyRoots = folders.filter(f => !f.parentId && f.type === 'shared' && !f.groupId);
  if (legacyRoots.length > 0) {
    const sharedLabel = el('div', 'px-2 py-1.5 text-[10px] text-txt-disabled font-bold uppercase tracking-widest mt-1', 'â”€â”€ ê³µìœ  â”€â”€');
    tree.appendChild(sharedLabel);
    legacyRoots.forEach(f => tree.appendChild(renderTreeItem(f, 0)));
  }

  const privateRoots = folders.filter(f => !f.parentId && f.type === 'private');
  const privateLabel = el('div', 'px-2 py-1.5 text-[10px] text-txt-disabled font-bold uppercase tracking-widest mt-3', 'â”€â”€ ê°œì¸ â”€â”€');
  tree.appendChild(privateLabel);
  privateRoots.forEach(f => tree.appendChild(renderTreeItem(f, 0)));

  // No groups message
  if (groups.length === 0 && legacyRoots.length === 0) {
    const noGroup = el('div', 'px-3 py-4 text-xs text-txt-disabled text-center', 'ê·¸ë£¹ì„ ë§Œë“¤ê±°ë‚˜\nì´ˆëŒ€ ì½”ë“œë¡œ ì°¸ì—¬í•˜ì„¸ìš”');
    tree.insertBefore(noGroup, tree.firstChild);
  }
}

function renderTreeItem(folder, depth) {
  const children = folders.filter(f => f.parentId === folder.id);
  const wrapper = document.createElement('div');

  const item = el('div', `tree-item flex items-center gap-1.5 px-2 py-1.5 rounded-lg text-sm ${folder.id === selectedFolderId ? 'selected' : ''}`, '');
  item.style.paddingLeft = (8 + depth * 16) + 'px';
  item.dataset.id = folder.id;

  const icon = folder.type === 'private' ? 'ğŸ”’' : 'ğŸ“';
  item.innerHTML = `<span>${icon}</span><span class="truncate flex-1">${esc(folder.name)}</span>${folder.id === selectedFolderId ? '<span class="text-accent-blue text-xs">â—€</span>' : ''}`;

  item.addEventListener('click', (e) => { e.stopPropagation(); selectFolder(folder.id); });

  wrapper.appendChild(item);
  children.forEach(c => wrapper.appendChild(renderTreeItem(c, depth + 1)));
  return wrapper;
}

// â”€â”€ Link Rendering â”€â”€
function renderLinks() {
  const container = document.getElementById('links');
  const empty = document.getElementById('emptyLinks');
  container.innerHTML = '';

  if (!selectedFolderId) {
    container.classList.add('hidden');
    empty.classList.remove('hidden');
    empty.classList.add('flex');
    empty.querySelector('span').textContent = 'í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”';
    return;
  }

  const folderLinks = linksData.filter(l => l.folderId === selectedFolderId);

  if (folderLinks.length === 0) {
    container.classList.add('hidden');
    empty.classList.remove('hidden');
    empty.classList.add('flex');
    empty.querySelector('span').textContent = 'ì´ í´ë”ì— ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤';
    return;
  }

  empty.classList.add('hidden');
  empty.classList.remove('flex');
  container.classList.remove('hidden');

  folderLinks.forEach(link => {
    const card = document.createElement('div');
    card.className = `link-card flex items-center gap-4 p-4 bg-bg-card rounded-xl border border-border ${link.id === selectedLinkId ? 'selected' : ''}`;
    card.dataset.id = link.id;

    const thumbSrc = link.ogImage || link.favicon || '';
    const thumbHtml = thumbSrc
      ? `<img src="${esc(thumbSrc)}" class="w-16 h-16 rounded-lg object-cover bg-bg-hover shrink-0" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`
        + `<div class="w-16 h-16 rounded-lg bg-bg-hover shrink-0 items-center justify-center text-2xl hidden">ğŸ”—</div>`
      : `<div class="w-16 h-16 rounded-lg bg-bg-hover shrink-0 flex items-center justify-center text-2xl">ğŸ”—</div>`;

    const title = link.ogTitle || link.title || link.url;
    const desc = link.ogDescription || '';
    const domain = getDomain(link.url);

    card.innerHTML = `
      ${thumbHtml}
      <div class="flex-1 min-w-0">
        <div class="text-sm font-medium truncate">${esc(title)}</div>
        ${desc ? `<div class="text-xs text-txt-secondary mt-0.5 line-clamp-2">${esc(desc)}</div>` : ''}
        <div class="text-xs text-txt-disabled mt-1">${esc(domain)}</div>
      </div>
    `;

    card.addEventListener('click', (e) => { e.stopPropagation(); selectLink(link.id); });
    card.addEventListener('dblclick', () => {
      if (window.electronAPI) { window.electronAPI.openExternal(link.url); }
      else { window.open(link.url, '_blank'); }
    });
    container.appendChild(card);
  });
}

// â”€â”€ Selection â”€â”€
function selectFolder(id) {
  selectedFolderId = id;
  selectedLinkId = null;
  closeSidebar();
  updateUI();
}

function selectLink(id) {
  selectedLinkId = id;
  updateUI();
}

function updateUI() {
  renderTree();
  renderLinks();
  updatePath();
  updateActionBar();
}

function updatePath() {
  const pathEl = document.getElementById('currentPath');
  if (!selectedFolderId) { pathEl.textContent = 'í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”'; return; }
  const parts = [];
  let current = folders.find(f => f.id === selectedFolderId);
  while (current) {
    parts.unshift(current.name);
    current = current.parentId ? folders.find(f => f.id === current.parentId) : null;
  }
  pathEl.textContent = parts.join(' > ');
}

function updateActionBar() {
  const info = document.getElementById('selectionInfo');
  const btnAddFolder = document.getElementById('btnAddFolder');
  const btnAddLink = document.getElementById('btnAddLink');
  const btnRename = document.getElementById('btnRename');
  const btnDelete = document.getElementById('btnDelete');

  if (selectedLinkId) {
    const link = linksData.find(l => l.id === selectedLinkId);
    info.textContent = `ì„ íƒ: ğŸ”— ${link ? link.title || link.url : ''}`;
    btnAddFolder.disabled = true;
    btnAddLink.disabled = true;
    btnRename.disabled = false;
    btnDelete.disabled = false;
  } else if (selectedFolderId) {
    const folder = folders.find(f => f.id === selectedFolderId);
    const icon = folder && folder.type === 'private' ? 'ğŸ”’' : 'ğŸ“';
    info.textContent = `ì„ íƒ: ${icon} ${folder ? folder.name : ''}`;
    btnAddFolder.disabled = false;
    btnAddLink.disabled = false;
    btnRename.disabled = false;
    btnDelete.disabled = false;
  } else {
    info.textContent = 'í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”';
    btnAddFolder.disabled = false;
    btnAddLink.disabled = true;
    btnRename.disabled = true;
    btnDelete.disabled = true;
  }
}

// â”€â”€ Modals â”€â”€
function openModal(title, bodyHtml, onConfirm) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = bodyHtml;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('modal').classList.add('flex');
  document.getElementById('modalConfirm').onclick = () => { onConfirm(); closeModal(); };
  const input = document.querySelector('#modalBody input');
  if (input) setTimeout(() => input.focus(), 100);
}

function closeModal() {
  document.getElementById('modal').classList.add('hidden');
  document.getElementById('modal').classList.remove('flex');
}

function showAddFolderModal() {
  const isRoot = !selectedFolderId;

  const groupOptions = groups.map(g =>
    `<option value="${g.id}">${esc(g.name)}</option>`
  ).join('');

  const typeSelect = isRoot
    ? `<div class="mb-3">
        <label class="text-xs text-txt-secondary block mb-1">ìœ í˜•</label>
        <div class="flex gap-2">
          <label class="flex-1 flex items-center gap-2 p-2 rounded-lg border border-border cursor-pointer has-[:checked]:border-accent-blue has-[:checked]:bg-accent-blue/10">
            <input type="radio" name="folderType" value="shared" checked class="accent-accent-blue" onchange="document.getElementById('groupSelect').classList.remove('hidden')"> <span class="text-sm">ğŸ“ ê³µìœ </span>
          </label>
          <label class="flex-1 flex items-center gap-2 p-2 rounded-lg border border-border cursor-pointer has-[:checked]:border-accent-blue has-[:checked]:bg-accent-blue/10">
            <input type="radio" name="folderType" value="private" class="accent-accent-blue" onchange="document.getElementById('groupSelect').classList.add('hidden')"> <span class="text-sm">ğŸ”’ ê°œì¸</span>
          </label>
        </div>
      </div>
      <div id="groupSelect" class="mb-3">
        <label class="text-xs text-txt-secondary block mb-1">ê·¸ë£¹</label>
        <select id="folderGroupInput" class="w-full bg-bg-main border border-border rounded-lg px-3 py-2 text-sm text-txt-primary outline-none focus:border-accent-blue transition">
          ${groupOptions || '<option value="" disabled selected>ê·¸ë£¹ì„ ë¨¼ì € ë§Œë“¤ì–´ì£¼ì„¸ìš”</option>'}
        </select>
      </div>`
    : '';

  openModal('í´ë” ì¶”ê°€', `
    ${typeSelect}
    <label class="text-xs text-txt-secondary block mb-1">í´ë” ì´ë¦„</label>
    <input id="folderNameInput" type="text" placeholder="í´ë” ì´ë¦„ ì…ë ¥" class="w-full bg-bg-main border border-border rounded-lg px-3 py-2 text-sm text-txt-primary outline-none focus:border-accent-blue transition">
  `, async () => {
    const name = document.getElementById('folderNameInput').value.trim();
    if (!name) return;

    let type, parentId, groupId = null;
    if (selectedFolderId) {
      const root = getRootFolder(selectedFolderId);
      type = root.type;
      parentId = selectedFolderId;
      groupId = root.groupId || null;
    } else {
      type = document.querySelector('input[name="folderType"]:checked')?.value || 'shared';
      parentId = null;
      if (type === 'shared') {
        groupId = document.getElementById('folderGroupInput')?.value || null;
        if (!groupId) return;
      }
    }

    await addFolder({
      name, parentId, type, groupId,
      ownerId: type === 'private' ? currentUser.uid : null,
      order: folders.length,
      createdBy: currentUser.email,
      createdAt: Date.now(),
      updatedBy: currentUser.email,
      updatedAt: Date.now()
    });
    await addLogEntry('create', 'folder', '', name, `í´ë” ìƒì„±: ${name}`, type);
  });
}

function showAddLinkModal() {
  if (!selectedFolderId) return;

  openModal('ë§í¬ ì¶”ê°€', `
    <label class="text-xs text-txt-secondary block mb-1">URL</label>
    <input id="linkUrlInput" type="text" placeholder="https://example.com" class="w-full bg-bg-main border border-border rounded-lg px-3 py-2 text-sm text-txt-primary outline-none focus:border-accent-blue transition mb-3">
    <label class="text-xs text-txt-secondary block mb-1">ì œëª© (ë¹„ì›Œë‘ë©´ ìë™ ì¶”ì¶œ)</label>
    <input id="linkTitleInput" type="text" placeholder="ì„ íƒì‚¬í•­" class="w-full bg-bg-main border border-border rounded-lg px-3 py-2 text-sm text-txt-primary outline-none focus:border-accent-blue transition">
  `, async () => {
    let url = document.getElementById('linkUrlInput').value.trim();
    const title = document.getElementById('linkTitleInput').value.trim();
    if (!url) return;
    if (!url.startsWith('http')) url = 'https://' + url;

    const folder = folders.find(f => f.id === selectedFolderId);
    const folderType = folder ? getRootFolder(folder.id)?.type || 'shared' : 'shared';

    const docRef = await addLink({
      folderId: selectedFolderId,
      title: title || url, url,
      ogTitle: '', ogDescription: '', ogImage: '', favicon: '',
      order: linksData.length,
      createdBy: currentUser.email,
      createdAt: Date.now(),
      updatedBy: currentUser.email,
      updatedAt: Date.now()
    });
    await addLogEntry('create', 'link', docRef.id, title || url, `ë§í¬ ì¶”ê°€: ${title || url} (${url})`, folderType);

    // Fetch OG data in background (Electron only)
    if (window.electronAPI) {
      try {
        const og = await window.electronAPI.fetchOG(url);
        const updateData = {};
        if (og.ogTitle) { updateData.ogTitle = og.ogTitle; if (!title) updateData.title = og.ogTitle; }
        if (og.ogDescription) updateData.ogDescription = og.ogDescription;
        if (og.ogImage) updateData.ogImage = og.ogImage;
        if (og.favicon) updateData.favicon = og.favicon;
        if (Object.keys(updateData).length > 0) {
          await updateLink(docRef.id, updateData);
        }
      } catch(e) {}
    }
  });
}

function showRenameModal() {
  if (selectedLinkId) {
    const link = linksData.find(l => l.id === selectedLinkId);
    if (!link) return;
    openModal('ë§í¬ ìˆ˜ì •', `
      <label class="text-xs text-txt-secondary block mb-1">ì œëª©</label>
      <input id="renameInput" type="text" value="${esc(link.title)}" class="w-full bg-bg-main border border-border rounded-lg px-3 py-2 text-sm text-txt-primary outline-none focus:border-accent-blue transition mb-3">
      <label class="text-xs text-txt-secondary block mb-1">URL</label>
      <input id="renameUrlInput" type="text" value="${esc(link.url)}" class="w-full bg-bg-main border border-border rounded-lg px-3 py-2 text-sm text-txt-primary outline-none focus:border-accent-blue transition">
    `, async () => {
      const newTitle = document.getElementById('renameInput').value.trim();
      const newUrl = document.getElementById('renameUrlInput').value.trim();
      const updates = { updatedBy: currentUser.email, updatedAt: Date.now() };
      if (newTitle) updates.title = newTitle;
      if (newUrl) updates.url = newUrl;
      await updateLink(link.id, updates);

      const folder = folders.find(f => f.id === link.folderId);
      const folderType = folder ? getRootFolder(folder.id)?.type || 'shared' : 'shared';
      await addLogEntry('update', 'link', link.id, newTitle || link.title, `ë§í¬ ìˆ˜ì •: ${newTitle || link.title}`, folderType);
    });
  } else if (selectedFolderId) {
    const folder = folders.find(f => f.id === selectedFolderId);
    if (!folder) return;
    openModal('í´ë” ì´ë¦„ ë³€ê²½', `
      <label class="text-xs text-txt-secondary block mb-1">í´ë” ì´ë¦„</label>
      <input id="renameInput" type="text" value="${esc(folder.name)}" class="w-full bg-bg-main border border-border rounded-lg px-3 py-2 text-sm text-txt-primary outline-none focus:border-accent-blue transition">
    `, async () => {
      const newName = document.getElementById('renameInput').value.trim();
      if (newName) {
        await updateFolder(folder.id, { name: newName, updatedBy: currentUser.email, updatedAt: Date.now() });
        await addLogEntry('update', 'folder', folder.id, newName, `í´ë” ì´ë¦„ ë³€ê²½: ${newName}`, folder.type);
      }
    });
  }
}

function deleteSelected() {
  if (selectedLinkId) {
    const link = linksData.find(l => l.id === selectedLinkId);
    if (!link) return;
    openModal('ë§í¬ ì‚­ì œ', `
      <p class="text-sm text-txt-secondary">"<span class="text-txt-primary">${esc(link.title)}</span>" ë§í¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    `, async () => {
      const folder = folders.find(f => f.id === link.folderId);
      const folderType = folder ? getRootFolder(folder.id)?.type || 'shared' : 'shared';
      await removeLink(link.id);
      await addLogEntry('delete', 'link', link.id, link.title, `ë§í¬ ì‚­ì œ: ${link.title}`, folderType);
      selectedLinkId = null;
    });
  } else if (selectedFolderId) {
    const folder = folders.find(f => f.id === selectedFolderId);
    if (!folder) return;

    const hasChildren = folders.some(f => f.parentId === selectedFolderId);
    const hasLinks = linksData.some(l => l.folderId === selectedFolderId);
    if (hasChildren || hasLinks) {
      openModal('ì‚­ì œ ë¶ˆê°€', `
        <p class="text-sm text-txt-secondary">í•˜ìœ„ í•­ëª©ì´ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>í•˜ìœ„ í´ë”ì™€ ë§í¬ë¥¼ ë¨¼ì € ì‚­ì œí•´ì£¼ì„¸ìš”.</p>
      `, () => {});
      return;
    }

    openModal('í´ë” ì‚­ì œ', `
      <p class="text-sm text-txt-secondary">"<span class="text-txt-primary">${esc(folder.name)}</span>" í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    `, async () => {
      await removeFolder(folder.id);
      await addLogEntry('delete', 'folder', folder.id, folder.name, `í´ë” ì‚­ì œ: ${folder.name}`, folder.type);
      selectedFolderId = null;
    });
  }
}

// â”€â”€ Logs â”€â”€
function showLogs() {
  const list = document.getElementById('logsList');
  list.innerHTML = '';
  if (logs.length === 0) {
    list.innerHTML = '<div class="text-center text-txt-disabled text-sm py-8">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
  } else {
    logs.slice(0, 50).forEach(log => {
      const time = getTimeAgo(log.timestamp);
      const div = document.createElement('div');
      div.className = 'flex flex-col gap-1.5 p-4 rounded-xl bg-bg-main border border-border';
      const actionIcon = log.action === 'create' ? 'â•' : log.action === 'update' ? 'âœï¸' : 'ğŸ—‘';
      const actionLabel = log.action === 'create' ? 'ì¶”ê°€' : log.action === 'update' ? 'ìˆ˜ì •' : 'ì‚­ì œ';
      const who = log.userName || log.user || '';
      div.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="text-base">${actionIcon}</span>
            <span class="text-sm font-medium text-accent-blue">${esc(who)}</span>
            <span class="text-xs px-2 py-0.5 rounded-full bg-bg-hover text-txt-secondary">${actionLabel}</span>
          </div>
          <span class="text-xs text-txt-disabled">${time}</span>
        </div>
        <div class="text-sm text-txt-primary pl-7">${esc(log.detail)}</div>
      `;
      list.appendChild(div);
    });
  }
  document.getElementById('logsModal').classList.remove('hidden');
  document.getElementById('logsModal').classList.add('flex');
}

function closeLogsModal() {
  document.getElementById('logsModal').classList.add('hidden');
  document.getElementById('logsModal').classList.remove('flex');
}

// â”€â”€ Helpers â”€â”€
function getRootFolder(folderId) {
  let f = folders.find(x => x.id === folderId);
  while (f && f.parentId) f = folders.find(x => x.id === f.parentId);
  return f;
}

function getDomain(url) {
  try { return new URL(url).hostname; } catch { return url; }
}

function getTimeAgo(ts) {
  const diff = Date.now() - ts;
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'ë°©ê¸ˆ ì „';
  if (mins < 60) return `${mins}ë¶„ ì „`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours}ì‹œê°„ ì „`;
  const days = Math.floor(hours / 24);
  return `${days}ì¼ ì „`;
}

function esc(str) {
  const d = document.createElement('div');
  d.textContent = str || '';
  return d.innerHTML;
}

function el(tag, cls, text) {
  const e = document.createElement(tag);
  e.className = cls;
  if (text) e.textContent = text;
  return e;
}

// Click outside to deselect link
document.addEventListener('click', (e) => {
  if (!e.target.closest('.link-card') && !e.target.closest('.action-btn') && !e.target.closest('#modal') && selectedLinkId) {
    selectedLinkId = null;
    updateUI();
  }
});

// Keyboard shortcut
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') { closeModal(); closeLogsModal(); }
  if (e.key === 'Delete' && !document.querySelector('#modal:not(.hidden)')) deleteSelected();
});

// â”€â”€ Group Functions â”€â”€
function generateInviteCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

function showCreateGroupModal() {
  openModal('ê·¸ë£¹ ë§Œë“¤ê¸°', `
    <label class="text-xs text-txt-secondary block mb-1">ê·¸ë£¹ ì´ë¦„</label>
    <input id="groupNameInput" type="text" placeholder="ì˜ˆ: ë””ìì¸íŒ€" class="w-full bg-bg-main border border-border rounded-lg px-3 py-2 text-sm text-txt-primary outline-none focus:border-accent-blue transition">
  `, async () => {
    const name = document.getElementById('groupNameInput').value.trim();
    if (!name) return;
    await window.fbAddDoc(window.fbCollection(window.fbDb, 'groups'), {
      name,
      ownerId: currentUser.uid,
      ownerName: currentUser.displayName || currentUser.email,
      members: [currentUser.uid],
      memberNames: { [currentUser.uid]: currentUser.displayName || currentUser.email },
      inviteCode: null,
      inviteCodeExpiry: null,
      createdAt: Date.now()
    });
  });
}

function showJoinGroupModal() {
  openModal('ê·¸ë£¹ ì°¸ì—¬', `
    <label class="text-xs text-txt-secondary block mb-1">ì´ˆëŒ€ ì½”ë“œ ì…ë ¥</label>
    <input id="joinCodeInput" type="text" placeholder="6ìë¦¬ ì½”ë“œ" maxlength="6" class="w-full bg-bg-main border border-border rounded-lg px-3 py-2 text-sm text-txt-primary outline-none focus:border-accent-blue transition uppercase tracking-widest text-center text-lg">
    <div id="joinError" class="text-xs text-accent-red mt-2 hidden"></div>
  `, async () => {
    const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
    if (!code || code.length !== 6) return;
    const errEl = document.getElementById('joinError');

    const q = window.fbQuery(
      window.fbCollection(window.fbDb, 'groups'),
      window.fbWhere('inviteCode', '==', code)
    );
    const snap = await window.fbGetDocs(q);
    if (snap.empty) {
      errEl.textContent = 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ˆëŒ€ ì½”ë“œì…ë‹ˆë‹¤';
      errEl.classList.remove('hidden');
      return;
    }
    const groupDoc = snap.docs[0];
    const groupData = groupDoc.data();

    if (groupData.inviteCodeExpiry && groupData.inviteCodeExpiry < Date.now()) {
      errEl.textContent = 'ë§Œë£Œëœ ì´ˆëŒ€ ì½”ë“œì…ë‹ˆë‹¤';
      errEl.classList.remove('hidden');
      return;
    }
    if (groupData.members.includes(currentUser.uid)) {
      errEl.textContent = 'ì´ë¯¸ ì°¸ì—¬í•œ ê·¸ë£¹ì…ë‹ˆë‹¤';
      errEl.classList.remove('hidden');
      return;
    }

    await window.fbUpdateDoc(window.fbDoc(window.fbDb, 'groups', groupDoc.id), {
      members: window.fbArrayUnion(currentUser.uid),
      [`memberNames.${currentUser.uid}`]: currentUser.displayName || currentUser.email
    });
    closeModal();
  });
}

function showGroupSettings(groupId) {
  const group = groups.find(g => g.id === groupId);
  if (!group) return;
  const isOwner = group.ownerId === currentUser.uid;
  const memberNames = group.memberNames || {};

  let membersHtml = '';
  group.members.forEach(uid => {
    const name = memberNames[uid] || uid;
    const isMe = uid === currentUser.uid;
    const isGroupOwner = uid === group.ownerId;
    let actions = '';
    if (isOwner && !isMe) {
      actions = `
        <button onclick="transferOwnership('${groupId}','${uid}')" class="text-[10px] text-accent-blue hover:underline">ê´€ë¦¬ì ìœ„ì„</button>
        <button onclick="kickMember('${groupId}','${uid}')" class="text-[10px] text-accent-red hover:underline">ë‚´ë³´ë‚´ê¸°</button>
      `;
    }
    membersHtml += `
      <div class="flex items-center justify-between py-2 px-1 ${!isMe ? 'border-b border-border/50' : ''}">
        <div class="flex items-center gap-2 min-w-0">
          <span class="text-sm truncate">${esc(name)}</span>
          ${isGroupOwner ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-accent-blue/20 text-accent-blue shrink-0">ê´€ë¦¬ì</span>' : ''}
        </div>
        <div class="flex items-center gap-2 shrink-0">${actions}</div>
      </div>
    `;
  });

  const inviteSection = isOwner ? `
    <div class="mb-4">
      <div class="text-xs text-txt-secondary mb-2">ì´ˆëŒ€ ì½”ë“œ</div>
      ${group.inviteCode && group.inviteCodeExpiry > Date.now()
        ? `<div class="flex items-center gap-2">
            <span class="text-lg font-mono tracking-widest text-txt-primary bg-bg-main px-3 py-1.5 rounded-lg border border-border">${group.inviteCode}</span>
            <button onclick="copyInviteCode('${group.inviteCode}')" class="text-xs text-accent-blue hover:underline">ë³µì‚¬</button>
          </div>
          <div class="text-[10px] text-txt-disabled mt-1">ë§Œë£Œ: ${new Date(group.inviteCodeExpiry).toLocaleString('ko-KR')}</div>`
        : `<div class="text-xs text-txt-disabled">í™œì„± ì½”ë“œ ì—†ìŒ</div>`
      }
      <button onclick="generateNewInviteCode('${groupId}')" class="mt-2 px-3 py-1.5 text-xs bg-accent-blue/20 text-accent-blue rounded-lg border border-accent-blue/30 hover:bg-accent-blue/30 transition">ìƒˆ ì½”ë“œ ìƒì„± (24ì‹œê°„)</button>
    </div>
  ` : '';

  const leaveSection = isOwner
    ? (group.members.length > 1
      ? `<div class="text-[10px] text-txt-disabled mt-3">ê´€ë¦¬ìë¥¼ ìœ„ì„í•œ í›„ ë‚˜ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>`
      : `<button onclick="deleteGroup('${groupId}')" class="mt-3 w-full px-3 py-2 text-xs bg-accent-red/20 text-accent-red rounded-lg border border-accent-red/30 hover:bg-accent-red/30 transition">ê·¸ë£¹ ì‚­ì œ</button>`)
    : `<button onclick="leaveGroup('${groupId}')" class="mt-3 w-full px-3 py-2 text-xs bg-accent-red/20 text-accent-red rounded-lg border border-accent-red/30 hover:bg-accent-red/30 transition">ê·¸ë£¹ ë‚˜ê°€ê¸°</button>`;

  document.getElementById('groupModalTitle').textContent = group.name + ' ì„¤ì •';
  document.getElementById('groupModalBody').innerHTML = `
    ${inviteSection}
    <div class="mb-2">
      <div class="text-xs text-txt-secondary mb-2">ë©¤ë²„ (${group.members.length}ëª…)</div>
      <div class="bg-bg-main rounded-lg border border-border p-2">${membersHtml}</div>
    </div>
    ${leaveSection}
  `;
  document.getElementById('groupModal').classList.remove('hidden');
  document.getElementById('groupModal').classList.add('flex');
}

function closeGroupModal() {
  document.getElementById('groupModal').classList.add('hidden');
  document.getElementById('groupModal').classList.remove('flex');
}

function copyInviteCode(code) {
  navigator.clipboard.writeText(code).then(() => {
    const btn = event.target;
    btn.textContent = 'ë³µì‚¬ë¨!';
    setTimeout(() => { btn.textContent = 'ë³µì‚¬'; }, 1500);
  });
}

async function generateNewInviteCode(groupId) {
  const code = generateInviteCode();
  await window.fbUpdateDoc(window.fbDoc(window.fbDb, 'groups', groupId), {
    inviteCode: code,
    inviteCodeExpiry: Date.now() + 24 * 60 * 60 * 1000
  });
  showGroupSettings(groupId);
}

async function kickMember(groupId, uid) {
  openModal('ë©¤ë²„ ë‚´ë³´ë‚´ê¸°', `
    <p class="text-sm text-txt-secondary">ì´ ë©¤ë²„ë¥¼ ê·¸ë£¹ì—ì„œ ë‚´ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?</p>
  `, async () => {
    const group = groups.find(g => g.id === groupId);
    const updates = { members: window.fbArrayRemove(uid) };
    updates[`memberNames.${uid}`] = null;
    await window.fbUpdateDoc(window.fbDoc(window.fbDb, 'groups', groupId), updates);
    showGroupSettings(groupId);
  });
}

async function transferOwnership(groupId, uid) {
  const group = groups.find(g => g.id === groupId);
  const name = group?.memberNames?.[uid] || uid;
  openModal('ê´€ë¦¬ì ìœ„ì„', `
    <p class="text-sm text-txt-secondary">"<span class="text-txt-primary">${esc(name)}</span>"ì—ê²Œ ê´€ë¦¬ì ê¶Œí•œì„ ë„˜ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?</p>
  `, async () => {
    await window.fbUpdateDoc(window.fbDoc(window.fbDb, 'groups', groupId), {
      ownerId: uid,
      ownerName: name
    });
    showGroupSettings(groupId);
  });
}

async function leaveGroup(groupId) {
  openModal('ê·¸ë£¹ ë‚˜ê°€ê¸°', `
    <p class="text-sm text-txt-secondary">ì •ë§ ì´ ê·¸ë£¹ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?<br>ë‚´ê°€ ë§Œë“  í´ë”ì™€ ë§í¬ëŠ” ê·¸ëŒ€ë¡œ ë‚¨ìŠµë‹ˆë‹¤.</p>
  `, async () => {
    const updates = { members: window.fbArrayRemove(currentUser.uid) };
    updates[`memberNames.${currentUser.uid}`] = null;
    await window.fbUpdateDoc(window.fbDoc(window.fbDb, 'groups', groupId), updates);
    closeGroupModal();
    selectedFolderId = null;
    selectedLinkId = null;
  });
}

async function deleteGroup(groupId) {
  openModal('ê·¸ë£¹ ì‚­ì œ', `
    <p class="text-sm text-txt-secondary">ê·¸ë£¹ì„ ì‚­ì œí•˜ë©´ ê·¸ë£¹ ë‚´ ëª¨ë“  í´ë”ì™€ ë§í¬ë„ ì‚­ì œë©ë‹ˆë‹¤.<br>ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
  `, async () => {
    // Delete all folders and links in this group
    const groupFolders = folders.filter(f => f.groupId === groupId);
    for (const f of groupFolders) {
      const fLinks = linksData.filter(l => l.folderId === f.id);
      for (const l of fLinks) await removeLink(l.id);
      await removeFolder(f.id);
    }
    await window.fbDeleteDoc(window.fbDoc(window.fbDb, 'groups', groupId));
    closeGroupModal();
    selectedFolderId = null;
    selectedLinkId = null;
  });
}

// â”€â”€ Sidebar Toggle (mobile) â”€â”€
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('active');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('active');
}

// â”€â”€ Electron Title Bar Setup â”€â”€
(function() {
  const titleBar = document.getElementById('titleBar');
  if (window.electronAPI) {
    titleBar.classList.add('drag-region');
    titleBar.style.paddingRight = '200px';
  }
})();

// â”€â”€ Pull to Refresh (mobile) â”€â”€
(function() {
  if (window.electronAPI) return;
  let startY = 0, pulling = false;
  const indicator = document.getElementById('pullIndicator');
  const threshold = 80;

  document.addEventListener('touchstart', (e) => {
    if (window.scrollY === 0) { startY = e.touches[0].clientY; pulling = true; }
  }, { passive: true });

  document.addEventListener('touchmove', (e) => {
    if (!pulling) return;
    const dy = e.touches[0].clientY - startY;
    if (dy > 0 && dy < 150) {
      indicator.style.transform = `translateX(-50%) translateY(${dy - 40}px)`;
      indicator.classList.add('visible');
    }
  }, { passive: true });

  document.addEventListener('touchend', (e) => {
    if (!pulling) return;
    pulling = false;
    const dy = parseInt(indicator.style.transform.match(/translateY\(([^)]+)px\)/)?.[1] || '0');
    if (dy + 40 >= threshold) {
      indicator.classList.add('refreshing');
      setTimeout(() => location.reload(), 300);
    } else {
      indicator.classList.remove('visible');
      indicator.style.transform = 'translateX(-50%) translateY(-50px)';
    }
  });
})();

// â”€â”€ Legacy Migration: ê¸°ì¡´ ê³µìœ í´ë”ë¥¼ ê·¸ë£¹ìœ¼ë¡œ ì´ë™ â”€â”€
let migrationDone = false;
async function migrateLegacyFolders() {
  if (migrationDone) return;
  const legacyRoots = folders.filter(f => !f.parentId && f.type === 'shared' && !f.groupId);
  if (legacyRoots.length === 0) { migrationDone = true; return; }

  // ì´ë¯¸ "ê¸°ë³¸ ê³µìœ " ê·¸ë£¹ì´ ìˆëŠ”ì§€ í™•ì¸
  const q = window.fbQuery(
    window.fbCollection(window.fbDb, 'groups'),
    window.fbWhere('name', '==', 'ê¸°ë³¸ ê³µìœ '),
    window.fbWhere('ownerId', '==', currentUser.uid)
  );
  const snap = await window.fbGetDocs(q);
  let groupId;
  if (snap.empty) {
    const docRef = await window.fbAddDoc(window.fbCollection(window.fbDb, 'groups'), {
      name: 'ê¸°ë³¸ ê³µìœ ',
      ownerId: currentUser.uid,
      ownerName: currentUser.displayName || currentUser.email,
      members: [currentUser.uid],
      memberNames: { [currentUser.uid]: currentUser.displayName || currentUser.email },
      inviteCode: null,
      inviteCodeExpiry: null,
      createdAt: Date.now()
    });
    groupId = docRef.id;
  } else {
    groupId = snap.docs[0].id;
  }

  // ëª¨ë“  ë ˆê±°ì‹œ ê³µìœ  í´ë”(ë£¨íŠ¸ + í•˜ìœ„)ì— groupId ë¶€ì—¬
  const allLegacy = folders.filter(f => f.type === 'shared' && !f.groupId);
  for (const f of allLegacy) {
    await window.fbUpdateDoc(window.fbDoc(window.fbDb, 'folders', f.id), { groupId });
  }
  migrationDone = true;
}

// â”€â”€ Init: Wait for Firebase â”€â”€
function init() {
  window.fbOnAuthStateChanged(window.fbAuth, onAuthChanged);
}

if (window.firebaseReady) {
  init();
} else {
  window.onFirebaseReady = init;
}
</script>
</body>
</html>
